ext.protobuf = [
    specFile: new File(sourceSets.main.resources.getSrcDirs().iterator().next(), 'ql2.proto'),
    srcDir: relativePath(sourceSets.main.java.getSrcDirs().iterator().next())
]

task protoApiDownload() {
    outputs.file project.ext.protobuf.specFile

    // TODO: In the future Gradle is going to support URLs in the Copy task.
    // from rethinkdb.api.url
    // into project.ext.protobuf.specFile

    doLast {
        ant.get(
                src: rethinkdb.api.url,
                dest: project.ext.protobuf.specFile,
                verbose: true
        )
    }
}

task protoApiCompile(type: Exec) {
    mustRunAfter protoApiDownload

    inputs.file project.ext.protobuf.specFile
    outputs.dir new File(project.ext.protobuf.srcDir, rethinkdb.api.package)

    executable 'protoc'
    args '--java_out=' + project.ext.protobuf.srcDir, relativePath(project.ext.protobuf.specFile)
}

tasks.compileJava.dependsOn protoApiCompile
